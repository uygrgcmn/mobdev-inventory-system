generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  products      Product[]
  suppliers     Supplier[]
  categories    Category[]
  transactions  StockTransaction[]
  notifications Notification[]
}

model User {
  id             Int      @id @default(autoincrement())
  username       String   @unique
  password       String
  role           Role
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime @default(now())

  // User-specific activity logging (audit trail)
  activities    UserActivity[]
  
  // Relations for tracking WHO did what (audit), but ownership belongs to Organization
  transactions  StockTransaction[] // Transactions performed by this user
}

enum Role {
  Admin
  Manager
  Staff
}

model Product {
  id           Int      @id @default(autoincrement())
  sku          String
  name         String
  category     String?
  quantity     Int      @default(0)
  unitPrice    Float    @default(0)
  supplierName String?
  expiryDate   String?
  barcode      String?
  minStock     Int      @default(5)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  categoryId  Int?
  categoryRel Category? @relation("ProductCategory", fields: [categoryId], references: [id])

  supplierId  Int?
  supplierRel Supplier? @relation("ProductSupplier", fields: [supplierId], references: [id])

  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])

  ownerUserId Int? // Added to track creator

  @@unique([sku, organizationId])
  @@index([categoryId])
  @@index([supplierId])
  @@index([organizationId])
}

model StockTransaction {
  id        Int      @id @default(autoincrement())
  sku       String
  change    Int
  reason    String
  createdAt DateTime @default(now())

  // Who performed the action
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Which organization owns this data
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  ownerUserId Int?

  @@index([organizationId])
  @@index([userId])
}

model Notification {
  id        Int      @id @default(autoincrement())
  sku       String?
  type      String
  message   String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())

  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])

  ownerUserId Int?

  @@unique([sku, type, message, resolved, organizationId])
  @@index([organizationId])
}

model Supplier {
  id        Int      @id @default(autoincrement())
  name      String
  phone     String?
  email     String?
  address   String?
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[] @relation("ProductSupplier")

  ownerUserId Int?

  @@unique([name, organizationId])
  @@index([organizationId])
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  products       Product[] @relation("ProductCategory")

  @@unique([name, organizationId])
  @@index([organizationId])
}

model UserActivity {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  path      String
  method    String
  status    Int
  createdAt DateTime @default(now())
  meta      Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
